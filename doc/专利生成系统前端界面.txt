<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ä¸“åˆ©è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- å¤´éƒ¨ -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-3xl font-bold">ğŸ”¬ AI ä¸“åˆ©è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ</h1>
                <p class="text-gray-200 mt-2">åŸºäºå¤šè§’è‰²åä½œçš„æ™ºèƒ½ä¸“åˆ©æ’°å†™å¹³å°</p>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-2xl font-bold mb-6">ç”Ÿæˆä¸“åˆ©æ–‡æ¡£</h2>
                        
                        <!-- æ¨¡å¼é€‰æ‹© -->
                        <div class="flex border-b mb-6">
                            <button onclick="switchMode('code')" id="tab-code" 
                                    class="px-6 py-3 font-semibold transition tab-active">
                                ä»ä»£ç ç”Ÿæˆ
                            </button>
                            <button onclick="switchMode('idea')" id="tab-idea" 
                                    class="px-6 py-3 font-semibold transition text-gray-600 hover:text-gray-800">
                                ä»åˆ›æ„ç”Ÿæˆ
                            </button>
                        </div>

                        <!-- ä»ä»£ç ç”Ÿæˆ -->
                        <div id="mode-code" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    ä»£ç ç›®å½•è·¯å¾„
                                </label>
                                <input type="text" id="code-directory" 
                                       value="." 
                                       placeholder="ä¾‹å¦‚: ./my-project"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-sm text-gray-500 mt-1">
                                    ç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æè¯¥ç›®å½•ä¸‹çš„ä»£ç å¹¶æå–æŠ€æœ¯åˆ›æ–°ç‚¹
                                </p>
                            </div>
                        </div>

                        <!-- ä»åˆ›æ„ç”Ÿæˆ -->
                        <div id="mode-idea" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æŠ€æœ¯åˆ›æ„æè¿°
                                </label>
                                <textarea id="idea-text" rows="8" 
                                          placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„æŠ€æœ¯åˆ›æ„ï¼ŒåŒ…æ‹¬ï¼š&#10;1. è¦è§£å†³çš„æŠ€æœ¯é—®é¢˜&#10;2. æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ&#10;3. é¢„æœŸçš„æŠ€æœ¯æ•ˆæœ&#10;4. åº”ç”¨åœºæ™¯ç­‰&#10;&#10;å»ºè®®è‡³å°‘ 200 å­—ä»¥ä¸Š..."
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                                <p class="text-sm text-gray-500 mt-1">
                                    <span id="idea-count">0</span> å­—ç¬¦ (å»ºè®®è‡³å°‘ 200 å­—)
                                </p>
                            </div>
                        </div>

                        <!-- è¿­ä»£æ¬¡æ•° -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                è¿­ä»£ä¼˜åŒ–è½®æ•°
                            </label>
                            <div class="flex items-center space-x-4">
                                <input type="range" id="iterations" min="1" max="10" value="3" 
                                       class="flex-1"
                                       oninput="updateIterations(this.value)">
                                <span class="text-2xl font-bold text-blue-600 w-12 text-center" id="iterations-value">3</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                ğŸ’¡ æ¯è½®åŒ…å«ï¼šä¸“åˆ©æ’°å†™å‘˜æ’°å†™ â†’ å®¡æŸ¥å‘˜å®¡æŸ¥ â†’ æ ¹æ®åé¦ˆæ”¹è¿›
                            </p>
                        </div>

                        <!-- ç”ŸæˆæŒ‰é’® -->
                        <div class="mt-8">
                            <button onclick="startGeneration()" 
                                    id="generate-btn"
                                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-purple-700 transition shadow-lg">
                                ğŸš€ å¼€å§‹ç”Ÿæˆä¸“åˆ©æ–‡æ¡£
                            </button>
                        </div>
                    </div>

                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="preview-section" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">æ–‡æ¡£é¢„è§ˆ</h2>
                            <button onclick="downloadPatent()" 
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                                ğŸ“¥ ä¸‹è½½ Markdown
                            </button>
                        </div>
                        <div id="patent-preview" class="prose max-w-none border-t pt-4"></div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šçŠ¶æ€å’Œå†å² -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- å½“å‰ä»»åŠ¡çŠ¶æ€ -->
                    <div id="status-card" class="bg-white rounded-lg shadow-md p-6 hidden">
                        <h3 class="text-xl font-bold mb-4">âš™ï¸ ç”ŸæˆçŠ¶æ€</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span id="status-stage">åˆå§‹åŒ–ä¸­...</span>
                                    <span id="status-progress">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div id="progress-bar" 
                                         class="bg-blue-600 h-2 rounded-full transition-all duration-500" 
                                         style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="text-sm text-gray-600 space-y-2">
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ¤–</span>
                                    <span>ä¸“åˆ©æ’°å†™å‘˜ï¼š<span id="writer-status">å¾…å‘½</span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ‘¨â€âš–ï¸</span>
                                    <span>å®¡æŸ¥å‘˜ï¼š<span id="reviewer-status">å¾…å‘½</span></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="mr-2">ğŸ”„</span>
                                    <span>å½“å‰è½®æ¬¡ï¼š<span id="current-iteration">0</span> / <span id="total-iterations">3</span></span>
                                </div>
                            </div>

                            <div id="status-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                                <p class="text-red-600 text-sm"></p>
                            </div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-bold mb-4">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">æ€»ä»»åŠ¡æ•°</span>
                                <span class="font-bold text-lg" id="stat-total">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">å·²å®Œæˆ</span>
                                <span class="font-bold text-lg text-green-600" id="stat-completed">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">è¿›è¡Œä¸­</span>
                                <span class="font-bold text-lg text-blue-600" id="stat-running">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">å¤±è´¥</span>
                                <span class="font-bold text-lg text-red-600" id="stat-failed">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- å†å²ä»»åŠ¡ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-bold mb-4">ğŸ“ å†å²ä»»åŠ¡</h3>
                        <div id="task-history" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">æš‚æ— å†å²ä»»åŠ¡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentTaskId = null;
        let pollInterval = null;
        let currentMode = 'code';

        // åˆå§‹åŒ–
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
        loadStats();
        loadTaskHistory();

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('mode-code').classList.toggle('hidden', mode !== 'code');
            document.getElementById('mode-idea').classList.toggle('hidden', mode !== 'idea');
            document.getElementById('tab-code').classList.toggle('tab-active', mode === 'code');
            document.getElementById('tab-idea').classList.toggle('tab-active', mode === 'idea');
            document.getElementById('tab-code').classList.toggle('text-gray-600', mode !== 'code');
            document.getElementById('tab-idea').classList.toggle('text-gray-600', mode !== 'idea');
        }

        // æ›´æ–°è¿­ä»£æ¬¡æ•°
        function updateIterations(value) {
            document.getElementById('iterations-value').textContent = value;
            document.getElementById('total-iterations').textContent = value;
        }

        // å­—ç¬¦è®¡æ•°
        document.getElementById('idea-text')?.addEventListener('input', (e) => {
            document.getElementById('idea-count').textContent = e.target.value.length;
        });

        // å¼€å§‹ç”Ÿæˆ
        async function startGeneration() {
            const btn = document.getElementById('generate-btn');
            const iterations = parseInt(document.getElementById('iterations').value);
            
            btn.disabled = true;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';

            try {
                let response;
                
                if (currentMode === 'code') {
                    const directory = document.getElementById('code-directory').value;
                    response = await fetch(`${API_BASE}/generate/code`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ directory, iterations })
                    });
                } else {
                    const idea = document.getElementById('idea-text').value;
                    if (idea.length < 50) {
                        alert('åˆ›æ„æè¿°è‡³å°‘éœ€è¦ 50 ä¸ªå­—ç¬¦');
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆä¸“åˆ©æ–‡æ¡£';
                        return;
                    }
                    response = await fetch(`${API_BASE}/generate/idea`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idea, iterations })
                    });
                }

                const data = await response.json();
                
                if (response.ok) {
                    currentTaskId = data.task_id;
                    showStatusCard();
                    startPolling();
                } else {
                    alert('å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆä¸“åˆ©æ–‡æ¡£';
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€å¡ç‰‡
        function showStatusCard() {
            document.getElementById('status-card').classList.remove('hidden');
            document.getElementById('preview-section').classList.add('hidden');
        }

        // å¼€å§‹è½®è¯¢
        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(async () => {
                if (!currentTaskId) return;
                
                try {
                    const response = await fetch(`${API_BASE}/tasks/${currentTaskId}`);
                    const task = await response.json();
                    
                    updateStatus(task);
                    
                    if (task.status === 'completed') {
                        clearInterval(pollInterval);
                        loadPreview(currentTaskId);
                        loadStats();
                        loadTaskHistory();
                    } else if (task.status === 'failed') {
                        clearInterval(pollInterval);
                        showError(task.error);
                    }
                } catch (error) {
                    console.error('è½®è¯¢å¤±è´¥:', error);
                }
            }, 2000);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(task) {
            const progress = task.progress || 0;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('status-progress').textContent = progress + '%';
            document.getElementById('status-stage').textContent = task.current_stage || 'å¤„ç†ä¸­...';
            
            // æ¨¡æ‹Ÿè§’è‰²çŠ¶æ€
            if (progress < 50) {
                document.getElementById('writer-status').textContent = 'æ’°å†™ä¸­...';
                document.getElementById('reviewer-status').textContent = 'å¾…å‘½';
            } else {
                document.getElementById('writer-status').textContent = 'å®Œæˆ';
                document.getElementById('reviewer-status').textContent = 'å®¡æŸ¥ä¸­...';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(error) {
            const errorDiv = document.getElementById('status-error');
            errorDiv.classList.remove('hidden');
            errorDiv.querySelector('p').textContent = error;
        }

        // åŠ è½½é¢„è§ˆ
        async function loadPreview(taskId) {
            try {
                const response = await fetch(`${API_BASE}/preview/${taskId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const preview = document.getElementById('patent-preview');
                    preview.innerHTML = marked.parse(data.content);
                    
                    // æ¸²æŸ“ Mermaid å›¾è¡¨
                    mermaid.init(undefined, preview.querySelectorAll('.language-mermaid'));
                    
                    document.getElementById('preview-section').classList.remove('hidden');
                    document.getElementById('status-card').classList.add('hidden');
                }
            } catch (error) {
                console.error('åŠ è½½é¢„è§ˆå¤±è´¥:', error);
            }
        }

        // ä¸‹è½½ä¸“åˆ©
        async function downloadPatent() {
            if (!currentTaskId) return;
            window.open(`${API_BASE}/download/${currentTaskId}`, '_blank');
        }

        // åŠ è½½ç»Ÿè®¡
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const stats = await response.json();
                
                document.getElementById('stat-total').textContent = stats.total_tasks;
                document.getElementById('stat-completed').textContent = stats.completed;
                document.getElementById('stat-running').textContent = stats.running;
                document.getElementById('stat-failed').textContent = stats.failed;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½å†å²ä»»åŠ¡
        async function loadTaskHistory() {
            try {
                const response = await fetch(`${API_BASE}/tasks`);
                const data = await response.json();
                
                const container = document.getElementById('task-history');
                
                if (data.tasks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— å†å²ä»»åŠ¡</p>';
                    return;
                }
                
                container.innerHTML = data.tasks.map(task => `
                    <div class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer"
                         onclick="viewTask('${task.id}')">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-semibold">${task.mode === 'code' ? 'ğŸ“ ä»£ç ' : 'ğŸ’¡ åˆ›æ„'}</span>
                            <span class="text-xs px-2 py-1 rounded ${getStatusClass(task.status)}">
                                ${getStatusText(task.status)}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${new Date(task.created_at).toLocaleString('zh-CN')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        function getStatusClass(status) {
            const classes = {
                completed: 'bg-green-100 text-green-800',
                running: 'bg-blue-100 text-blue-800',
                failed: 'bg-red-100 text-red-800',
                pending: 'bg-gray-100 text-gray-800'
            };
            return classes[status] || classes.pending;
        }

        function getStatusText(status) {
            const texts = {
                completed: 'å®Œæˆ',
                running: 'è¿è¡Œä¸­',
                failed: 'å¤±è´¥',
                pending: 'ç­‰å¾…'
            };
            return texts[status] || status;
        }

        function viewTask(taskId) {
            currentTaskId = taskId;
            loadPreview(taskId);
        }

        // å®šæœŸåˆ·æ–°
        setInterval(() => {
            loadStats();
            loadTaskHistory();
        }, 10000);
    </script>
</body>
</html>